<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Fixed Cube (Direct Method)</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    .info-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      z-index: 999;
      border-radius: 5px;
      max-width: 300px;
    }

    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px;
      font-family: monospace;
      z-index: 999;
      font-size: 12px;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: Arial, sans-serif;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    
    .overlay h2 {
      margin-bottom: 20px;
    }
    
    .overlay p {
      margin-bottom: 20px;
      max-width: 600px;
    }
    
    .overlay button {
      padding: 12px 24px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <div id="startOverlay" class="overlay">
    <h2>AR Cube Fixed in World Space</h2>
    <p>This demo uses a marker to position a cube that stays fixed in real-world space.</p>
    <p>Display this marker on your screen or print it:</p>
    <iframe src="https://raw.githack.com/AR-js-org/AR.js/master/data/images/hiro.png" style="background: white; width: 80%; max-width: 300px; height: 300px;"></iframe>
    <p>Once placed, the cube will stay fixed in position even when the marker is no longer visible.</p>
    <button id="startButton">Start AR Experience 4</button>
  </div>

  <div id="debug"></div>
  <div class="info-panel" id="infoPanel" style="display: none;">
    Point the camera at the HIRO marker to place the cube.
  </div>

  <a-scene 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false">
    
    <!-- This is our marker -->
    <a-marker preset="hiro" id="hiroMarker">
      <!-- Just a visual indicator when marker is visible -->
      <a-box position="0 0.1 0" width="1" height="0.1" depth="1" color="yellow" opacity="0.5"></a-box>
      <a-text value="Marker Detected" position="0 0.3 0" align="center" color="green" scale="0.5 0.5 0.5"></a-text>
    </a-marker>
    
    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Main initialization
    window.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('startButton');
      const startOverlay = document.getElementById('startOverlay');
      const infoPanel = document.getElementById('infoPanel');
      const debugPanel = document.getElementById('debug');
      
      let hasPlacedCube = false;
      let scene, camera, cube;
      
      // Initialize Three.js scene for direct manipulation
      function initThreeJS() {
        // Get the A-Frame scene and camera
        scene = document.querySelector('a-scene').object3D;
        camera = document.querySelector('[camera]').object3D;
        
        // Get the marker
        const marker = document.querySelector('#hiroMarker').object3D;
        
        // Track marker visibility
        let isMarkerVisible = false;
        let markerControls = document.querySelector('#hiroMarker').components['arjs-anchor'];
        
        // Create a debug function
        function debugLog(text) {
          debugPanel.innerHTML = text;
          console.log(text);
        }
        
        // Monitor marker visibility
        setInterval(function() {
          if (markerControls && markerControls.context && markerControls.context.arController) {
            const pattern = markerControls.context.arController.patternMarkers[0];
            if (pattern) {
              isMarkerVisible = pattern.inCurrent;
              if (!hasPlacedCube && isMarkerVisible) {
                placeCube();
              }
            }
          }
        }, 100);
        
        // Function to place cube in absolute world coordinates
        function placeCube() {
          if (hasPlacedCube) return;
          
          // Create a new THREE.js cube directly
          const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
          const material = new THREE.MeshNormalMaterial();
          const cubeMesh = new THREE.Mesh(geometry, material);
          
          // Get the marker's current world position matrix
          const markerWorldMatrix = new THREE.Matrix4();
          marker.matrixWorld.decompose(
            new THREE.Vector3(),
            new THREE.Quaternion(),
            new THREE.Vector3()
          );
          markerWorldMatrix.copy(marker.matrixWorld);
          
          // Extract position from marker matrix
          const position = new THREE.Vector3();
          const quaternion = new THREE.Quaternion();
          const scale = new THREE.Vector3();
          markerWorldMatrix.decompose(position, quaternion, scale);
          
          // Adjust position to be 5 feet (1.5m) above the marker
          position.y += 1.5;
          
          // Set the cube's position directly in world space
          cubeMesh.position.copy(position);
          
          // Add the cube directly to the Three.js scene
          scene.add(cubeMesh);
          
          // Apply rotation animation
          const clock = new THREE.Clock();
          function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            cubeMesh.rotation.y += delta * 0.5;
          }
          animate();
          
          // Flag that we've placed the cube
          hasPlacedCube = true;
          
          // Update UI
          infoPanel.innerHTML = 'Cube placed! It will stay fixed in world space.';
          debugLog(`Cube placed at position: x:${position.x.toFixed(2)} y:${position.y.toFixed(2)} z:${position.z.toFixed(2)}`);
        }
      }
      
      // Start AR experience
      startButton.addEventListener('click', function() {
        startOverlay.style.display = 'none';
        infoPanel.style.display = 'block';
        debugPanel.style.display = 'block';
        
        // Initialize after a short delay to ensure all components are loaded
        setTimeout(initThreeJS, 1000);
      });
    });
  </script>
</body>
</html>