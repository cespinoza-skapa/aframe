<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Cube with Persistent Position</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    .info-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-family: Arial, sans-serif;
      z-index: 999;
      border-radius: 5px;
      max-width: 300px;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: Arial, sans-serif;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    
    .overlay h2 {
      margin-bottom: 20px;
    }
    
    .overlay p {
      margin-bottom: 20px;
      max-width: 600px;
    }
    
    .overlay img {
      max-width: 80%;
      margin: 20px 0;
      border: 2px solid white;
    }
    
    .overlay button {
      padding: 12px 24px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>

  <!-- Add custom component for persistent cubes -->
  <script>
    // A component to place a persistent cube in world space
    AFRAME.registerComponent('persistent-cube', {
      init: function() {
        const sceneEl = document.querySelector('a-scene');
        this.worldCube = null;
        this.isPlaced = false;
        this.marker = document.querySelector('#marker');
        this.markerObj = this.marker.object3D;
        
        // Set up the world position matrices
        this.worldPos = new THREE.Vector3();
        this.worldQuat = new THREE.Quaternion();
        this.worldScale = new THREE.Vector3();
        
        // Listen for marker found event
        this.marker.addEventListener('markerFound', this.onMarkerFound.bind(this));
      },
      
      onMarkerFound: function() {
        // Only place the cube once
        if (this.isPlaced) return;
        
        // Get the world position of the marker
        this.markerObj.getWorldPosition(this.worldPos);
        this.markerObj.getWorldQuaternion(this.worldQuat);
        this.markerObj.getWorldScale(this.worldScale);
        
        // Adjust height to place cube 5 feet (1.5m) above marker
        this.worldPos.y += 1.5; 
        
        // Create the persistent cube in world space
        const cube = document.createElement('a-entity');
        cube.setAttribute('id', 'persistent-cube');
        cube.setAttribute('geometry', 'primitive: box; width: 0.5; height: 0.5; depth: 0.5');
        cube.setAttribute('material', 'color: red');
        cube.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 8000');
        
        // Set position, rotation, and scale directly from matrix
        cube.object3D.position.copy(this.worldPos);
        cube.object3D.quaternion.copy(this.worldQuat);
        
        // Add to the scene
        document.querySelector('a-scene').appendChild(cube);
        
        // Add a text label above the cube
        const text = document.createElement('a-text');
        text.setAttribute('value', 'Fixed Cube (5ft above original marker position)');
        text.setAttribute('align', 'center');
        text.setAttribute('position', `0 0.6 0`);
        text.setAttribute('scale', '0.5 0.5 0.5');
        text.setAttribute('color', 'white');
        text.setAttribute('look-at', '[camera]');
        cube.appendChild(text);
        
        // Add a vertical line down to the original marker position
        const line = document.createElement('a-entity');
        line.setAttribute('line', 'start: 0 0 0; end: 0 -1.5 0; color: blue');
        cube.appendChild(line);
        
        // Store reference to the cube
        this.worldCube = cube;
        this.isPlaced = true;
        
        // Update the info panel
        document.getElementById('infoPanel').innerHTML = 
          'Cube placed and fixed in world space!<br>The cube will remain visible even when the marker is out of view.';
          
        console.log('Persistent cube placed at:', this.worldPos);
      }
    });
  </script>
</head>
<body style="margin: 0; overflow: hidden;">
  <div id="startOverlay" class="overlay">
    <h2>Persistent AR Cube</h2>
    <p>This demo uses a marker to initially position a cube, then keeps it fixed in that position even when the marker is no longer visible.</p>
    <p>Display this marker on another device or print it:</p>
    <img src="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" alt="HIRO marker">
    <p>When the marker is detected, a cube will appear 5 feet (1.5m) above it and stay there permanently.</p>
    <button id="startButton">Start AR Experience 3</button>
  </div>

  <!-- A-Frame Scene with AR.js -->
  <a-scene 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    vr-mode-ui="enabled: false">
    
    <!-- This is our marker that we'll use for initial positioning -->
    <a-marker preset="hiro" id="marker" persistent-cube>
      <!-- Visual indicator when marker is visible -->
      <a-box position="0 0.1 0" width="1" height="0.1" depth="1" color="yellow" opacity="0.5"></a-box>
      <a-text value="Marker Detected" position="0 0.3 0" align="center" color="green" scale="0.5 0.5 0.5"></a-text>
    </a-marker>
    
    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <div class="info-panel" id="infoPanel" style="display: none;">
    Point the camera at the HIRO marker to place the cube.<br>
    Once placed, the cube will stay fixed in real-world space even when the marker is no longer visible.
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('startButton');
      const startOverlay = document.getElementById('startOverlay');
      const infoPanel = document.getElementById('infoPanel');
      
      // Start AR experience
      startButton.addEventListener('click', function() {
        startOverlay.style.display = 'none';
        infoPanel.style.display = 'block';
      });
    });
  </script>
</body>
</html>