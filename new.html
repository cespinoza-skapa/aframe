<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Box Interaction</title>
    
    <!-- A-Frame and AR.js libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            z-index: 9999;
        }
        
        #popupMessage {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            max-width: 80%;
        }
        
        #closeButton {
            display: block;
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .say-hi-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- Loading screen -->
    <div id="loading">
        <div>Getting your location... Please wait and allow location access.</div>
    </div>
    
    <!-- Popup message -->
    <div id="popupMessage">
        <p>You've interacted with the 3D box!</p>
        <button id="closeButton">Close</button>
    </div>
    
    <!-- A-Frame scene with AR.js -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        embedded>

        <!-- This camera uses GPS to track user's location -->
        <a-camera id="camera" gps-projected-camera="simulateLatitude: 0; simulateLongitude: 0;" rotation-reader></a-camera>

    </a-scene>
    
    <button class="say-hi-button" id="placeBoxButton">Place Box 10ft Away</button>

    <script>
        // Wait for the scene to load
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('#camera');
            const loading = document.getElementById('loading');
            const placeButton = document.getElementById('placeBoxButton');
            let boxPlaced = false;
            
            // Handle the place box button
            placeButton.addEventListener('click', function() {
                if (!boxPlaced) {
                    placeFixedBox();
                    boxPlaced = true;
                    placeButton.style.display = 'none';
                }
            });

            // Get user's location and set up the camera
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Set camera position
                    camera.setAttribute('gps-projected-camera', {
                        simulateLatitude: latitude,
                        simulateLongitude: longitude
                    });
                    
                    // Hide loading screen
                    loading.style.display = 'none';
                    
                }, function(error) {
                    console.error('Error getting location:', error);
                    alert('Error getting your location. Please ensure location services are enabled.');
                    loading.style.display = 'none';
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                });
            } else {
                alert('Geolocation is not supported by this browser.');
                loading.style.display = 'none';
            }
            
            // Function to place a fixed box 10 feet (approximately 3 meters) away
            function placeFixedBox() {
                // Get current position
                navigator.geolocation.getCurrentPosition(function(position) {
                    const currentLat = position.coords.latitude;
                    const currentLon = position.coords.longitude;
                    
                    // Calculate position 10 feet (~3 meters) in front of user
                    // This is a simple approximation for small distances
                    // 0.00003 degrees is roughly 3 meters at the equator
                    const heading = getCompassHeading();
                    const distance = 0.00003; // approx 3 meters in degrees
                    
                    // Calculate new position based on heading
                    const targetLat = currentLat + distance * Math.cos(heading * Math.PI / 180);
                    const targetLon = currentLon + distance * Math.sin(heading * Math.PI / 180);
                    
                    // Create the box
                    const box = document.createElement('a-box');
                    box.setAttribute('gps-projected-entity-place', {
                        latitude: targetLat,
                        longitude: targetLon
                    });
                    box.setAttribute('position', '0 1.6 0'); // Height at eye level
                    box.setAttribute('scale', '1 1 1');
                    box.setAttribute('color', '#4285F4');
                    box.setAttribute('class', 'clickable');
                    box.setAttribute('look-at', '[gps-projected-camera]');
                    
                    // Add click event to the box
                    box.addEventListener('click', showPopup);
                    
                    // Also listen for touch events for mobile
                    box.addEventListener('touchend', showPopup);
                    
                    // Add box to the scene
                    scene.appendChild(box);
                    
                    console.log('Box placed at:', targetLat, targetLon);
                });
            }
            
            // Function to get compass heading (direction user is facing)
            function getCompassHeading() {
                // Default to North if compass not available
                return 0;
            }
            
            // Function to show popup
            function showPopup() {
                const popup = document.getElementById('popupMessage');
                popup.style.display = 'block';
                
                // Add close button functionality
                document.getElementById('closeButton').addEventListener('click', function() {
                    popup.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>